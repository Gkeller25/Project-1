<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    
    <!--link rel="stylesheet" type="text/css" href="assets/css/style.css"-->
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Abril+Fatface" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <title>SpoTube | Music Redefined</title>
    

  </head>
  <body>
  <div class="container" id="head-container">
        <div class="container">
                <div id="login">
                  
                  <a href="/login" class="btn btn-primary">Log in with Spotify</a>
                </div>
                <div id="loggedin">
                  <div id="user-profile">
                  </div>
                  <div id="oauth">
                  </div>
                  
                </div>
              </div>
    <div class="jumbotron" id="head">
        <h1> SpoTube </h1>
        <h3>Music Refined</h3>
    </div>
</div>

<div class="container" id="dataBody">
    <div class="modal fade" id="expireModal" tabindex="-1" role="dialog" aria-labelledby="expireModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="expireModalLabel"></h5>
              <button id="xButton" type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              You still there?
            </div>
            <div class="modal-footer">
           
              <button class="btn btn-default" id="obtain-new-token" data-dismiss="modal">Obtain new token using the refresh token</button>
            </div>
          </div>
        </div>
      </div>
  
  <div class="panel panel-default mb-3">
      <div class="panel-heading panel-custom mb-3">
        <a class="btn btn-primary" id="results-button" data-toggle="collapse" href="#collapseSearch" role="button" aria-expanded="false" aria-controls="collapseSearch" style="visibility:hidden">
         Search Results
        </a>
      </div>
      <div class="collapse show" id="collapseSearch">
        <div  id="search-results">
        </div>
      
      </div>

  <div class="modal fade" id="videoModal" tabindex="-1" role="dialog" aria-labelledby="videoModal" aria-hidden="true">
      <div class="modal-dialog" id="sizeModal">
        <div class="modal-content">
          <div class="modal-body">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <div id="player">
              <iframe width="100%" height="800" src=""></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div class="panel panel-default">
    <div class="panel-heading panel-custom">  Add Song </div>
    <div class="panel-body">
        <form>
            <div class="form-group">
                <label for="song-search">Search</label>
                <input type="text" class="form-control" id="song-search">
            </div>
            <div class="btn-group" role="group">
                <button type="button" id="btn-add" class="btn search-button">Search</button>
            </div>
        </form>
    </div>
</div>


</body>

<script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
      <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
      <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>


  <script>
    
    (function() {

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
            q = window.location.hash.substring(1);
        while ( e = r.exec(q)) {
           hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      var params = getHashParams();

      var access_token = params.access_token,
          refresh_token = params.refresh_token,
          error = params.error;
      

      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
        
//make a timeout that triggers a function after 60minutes targets the modal to pop up
setTimeout(function () {$("#expireModal").modal('show');}, 3600000);
$("#xButton").on("click", function(){
  $("#login").show();
})
          $.ajax({
    url: 'https://api.spotify.com/v1/me/playlists',
    headers: {
      'Authorization': 'Bearer ' + access_token
    },
    success: function(response) {
      
     var playResults = response.items;
      
      var playlistHead = $('<div class="accordion" id="accordionPlaylists">');
     $("#dataBody").append(playlistHead);
  
      for(var i = 0; i < playResults.length; i++){
        (function (i){
  
       //dynamic html for playlists     
        var playlistBody = $("<div>");  
        var pLists = $("<p>");
        var songTracks = $("<div>");
        playlistBody.attr("id", "playlist" + [i]);
  
          pLists.text(playResults[i].name);
          $("#playlists").append(playlistBody);
          $("#playlist"+[i]).append(pLists);
          $("#playlist"+[i]).append(songTracks);
          
          playlistID = playResults[i].id;
          userId = playResults[i].owner.id;
          trackCount = playResults[i].tracks.total;
   
  
  
  
   //call gives me everything i need in a single call look into not doing the first call and see how that works out
        $.ajax({
          url: 'https://api.spotify.com/v1/users/'+ userId +'/playlists/'+playlistID+ '/',
          headers: {
      'Authorization': 'Bearer ' + access_token
    },
    success: function(result) {
 
      var pName = result.name;
      var pId = result.id;
      var trackName = result.tracks
      var trackList = result.tracks.items;
      
  
  var plCard = $('<div class="">');
  var plCardHead = $('<div class="card">');
  var plWrap = $('<div class="mb-0">');
  var plButton = $('<a class="display-4"  data-toggle="collapse"  aria-expanded="false" >');      
  var plTarget = $('<div class="collapse" data-parent="#accordionPlaylists">');
  var plCardBody = $('<div class="results">');
  var songList = $("<ul class='text-warning'style='list-style-type:none'>");  


  var plHeading = "heading" + pId;
  var plWrapping = "wrapping" + pId;  //h5
  var plCollapse = "collapse" + pId;
  var plTargeted = "target" + pId;
  var plSongList = "list" + pId; 
  var plCardId = "#"+ pId;
  var plHeadingId = "#" + plHeading;
  var plWrappingId = "#" + plWrapping;
  var plCollapseId = "#" + plCollapse;
  var plTargetId = "#" + plTargeted;
  var plSongListId = "#" + plSongList;
  

 
  
  plCard.attr("id", pId);
  plCardHead.attr("id", plHeading);
  plWrap.attr("id", plWrapping);
  plButton.attr({
    href: plCollapseId,
    "data-target": plCollapseId,
    "aria-controls": plCollapse
  });
  plTarget.attr({
    id: plCollapse,
    "aria-labelledby": plHeading
  });
  plCardBody.attr("id", plTargeted);
  songList.attr("id", plSongList);
  plButton.text(pName);

  

  $("#accordionPlaylists").append(plCard);
  plCard.append(plCardHead);
  plCardHead.append(plWrap);
  plWrap.append(plButton);
  plCard.append(plTarget);
  plTarget.append(plCardBody);
  plCardBody.append(songList);
  var noSpace = pName.replace(/\s/g, '');
  
  //returns back all the tracks per playlist in an array
  console.log(trackList);
  if(trackList){
  
  $.each(trackList, function(j){
  
  var tId = trackList[j].track.id;
  var artists = trackList[j].track.artists;
  var artistArr = [];

  $.each(artists, function(k){
    var multiArtists = artists[k].name;
    artistArr.push(multiArtists);
  })  
  //adds spacing after the comma
  var artist = artistArr.join(', ');
  
  var title = trackList[j].track.name;
  var album = trackList[j].track.album.name;

  var albumArtImg = trackList[j].track.album.images[1].url;
  var videoSearchValue =  artist + title + " official";
  var previewClip = trackList[j].track.preview_url;
  var plTrackList = $('<li>');
  var songToggle = $('<a class="text-warning" data-toggle="collapse"  role="button" aria-expanded="false" >');
  var songInfoDiv = $('<div class="collapse">');

  var songInfoTable = $('<table class="table table-hover">');
  var tableHeadRow = $('<tr>');
  var tableHeadArtist = $('<th scope="col">');
  var tableHeadAlbum = $("<th scope='col'>");
  var innerCollapseDiv = $('<div>');
  var trackTableHead =$('<thead>');
  var trackTableBody = $('<tbody>');
  var tableDataRow = $('<tr>');
  var tableDataRow2 = $('<tr>');
  var tableDataRow3 = $('<tr>');
  var trackAlbum = $('<td>');
  var trackArtist = $('<td>');
  var mvButton = $('<button class="btn btn-primary music-video">')
  
  var tableWrap = $('<div class="d-flex results">');
  var trackButton = $('<td>');
  var trackPreview = $('<td>');
  var albumImg = $('<img >');
  var audioClip = $('<audio controls preload="auto">');
  var playerAudio = $('<source>');
  
  

  var plTrack = [j]+noSpace + tId;
  var songToggleLink = [j]+noSpace + "link" + tId;
  var songToggler = [j]+noSpace + "collapse" + tId;
  var songInfoDiver = [j]+noSpace + "div" + tId;
  var songInfoTabler = [j]+noSpace + "table" + tId;
  var innerDiv = [j]+noSpace + "inner" + tId;
  var headRow = [j]+noSpace + "head-row" + tId;
  var tableBody = [j]+noSpace + "table-data" + tId;
  var tableAlbum = [j]+noSpace + "album" + tId;
  var tableArtist = [j]+noSpace + "artist" + tId;
  var dataRow2 = [j]+noSpace + "row2" + tId;
  var dataRow3 = [j]+noSpace + "row3" + tId;
  var songAlbum = [j]+noSpace + "sngAlbum" + tId;
  var songArtist = [j]+noSpace + "sngArtist" + tId;
  var tableHead = [j]+noSpace + "head" + tId;
  var mvBtn = [j]+noSpace + "song" + tId;
  var tableWrapper  = [j]+noSpace + "wrap" + tId;
  var tableButton  = [j]+noSpace + "button" + tId;
  var albumArt = [j]+noSpace + "art" + tId;
  var songPreview = [j]+noSpace + "preview" + tId;
  var songClip = [j]+noSpace + "clip" + tId;
  var aPlayer = [j]+noSpace + "player" + tId;
  var plTrackListId = "#" + plTrack;
  var mvBtnId = "#" + mvBtn;

  var songToggleId = "#" + songToggler;
  var songToggleLinkId = "#" + songToggleLink;
  var innerDivId = "#" + innerDiv;
  var headRowId = "#" + headRow;
  var songInfoTableId = "#" + songInfoTabler;
  var tableBodyId = "#" + tableBody;
  var tableAlbumId = "#" + tableAlbum;
  var tableArtistId = "#" + tableArtist;
  //var tableDataRowId = "#" + dataRow;
  var songAlbumId = "#" + songAlbum;
  var songArtistId = "#" + songArtist;
  var tableHeadId = "#" + tableHead;
  var tableButtonId  = "#" + tableButton;
  var tableWrapperId = "#" + tableWrapper;
  var albumArtId = "#" + albumArt;
  var songPreviewId = "#" + songPreview;
  
  var songClipId = "#" + songClip;
  var aPlayerId = "#" + aPlayer;
  
  plTrackList.attr("id", plTrack);
  songToggle.attr({
    id: songToggleLink,
    href: songToggleId,
    "aria-controls": songToggler
   });
  innerCollapseDiv.attr("id", innerDiv);
  songInfoDiv.attr({
    id: songToggler,
    "data-parent": plSongListId
  });
  songInfoTable.attr("id", songInfoTabler);
  if(tableAlbumId){
  tableHeadAlbum.text("Album").attr("id", tableAlbumId);
  tableHeadArtist.text("Artist").attr("id", tableArtistId);
  }
  tableHeadRow.attr("id", headRow);
  //tableDataRow.attr("id", dataRow);
  trackTableBody.attr("id", dataRow2);
  tableDataRow2.attr("id",dataRow3);
  tableDataRow3.attr("id", tableBody);
  trackArtist.attr("id", songArtist);
  trackAlbum.attr("id", songAlbum);
  trackTableHead.attr("id", tableHead);
  mvButton.attr("id", mvBtn);
  tableWrap.attr("id", tableWrapper);
  trackButton.attr("id", tableButton);
  albumImg.attr("id", albumArt);
  trackPreview.attr("id", songPreview);
  audioClip.attr("id", songClip);
  playerAudio.attr("id", aPlayer);
  

  songList.append(plTrackList);
  plTrackList.append(songToggle);
  plTrackList.append(innerCollapseDiv);
  innerCollapseDiv.append(songInfoDiv);
  songInfoDiv.append(tableWrap);
  tableWrap.append(songInfoTable);
  songInfoTable.append(trackTableHead);
  trackTableHead.append("<tr><th scope='col'>" + "Title" + "</th><th scope='col'>" + "Artist" + "</th><th scope='col'>" + "Album" + "</th></tr>"); 
  //tableHeadRow.append(tableHeadArtist);
  //tableHeadRow.append(tableHeadAlbum);
  songInfoTable.append(trackTableBody);
  
  trackTableBody.append("<tr><td class='title'>" + title + "</td><td class='artist'>" + artist + "</td><td class='album'>" + album + "</td></tr>");
  trackTableBody.append(tableDataRow2);
  trackTableBody.append(tableDataRow3);
  tableDataRow2.append(trackPreview);
  tableDataRow3.append(trackButton);
  trackButton.append(mvButton);
  tableWrap.prepend(albumImg);
  trackPreview.append(audioClip);
  audioClip.append(playerAudio);

   //handles when there is more than one artist credited for a track
 
  
  songToggle.text(title);
  $(songAlbumId).text(album);
  $(songArtistId).text(artist);
  $(mvBtnId).text("Music Video").attr({
    "data-toggle": "modal",
     "data-target": "#videoModal",
     "data-video": videoSearchValue
  }); 
  $(albumArtId).attr("src", albumArtImg);
  
  $(aPlayerId).attr("src", previewClip);
   
  })
  }
    }  
    
  })
  }(i))
  }
$(document).one("click", "#btn-add", function(){
  if($("#song-search").val().trim() === ""){
return false;
  } else {
  $("#results-button").removeAttr("style");
}
})
$("#btn-add").on("click", function(event){
event.preventDefault();

var name = $("#song-search").val().trim();
console.log(name);
if(name === ""){
  return false;
} else{
var searchReady = name.replace(/\s/g, '%20');
console.log(searchReady);


$.ajax({
  url: 'https://api.spotify.com/v1/search?q=' + searchReady + '&type=track&market=US',
  headers: {
    'Authorization': 'Bearer ' + access_token
  },
  success: function(response) {
    var results = response.tracks;
var queryURL = response.tracks.next;
var nextButton = $('<button  type="button" id="btn-next" class="btn btn-primary searchNav">' + '</button>');
var prevButton = $('<button  type="button" id="btn-prev" class="btn btn-primary searchNav" disabled>' + '</button>');
$("#collapseSearch").append(prevButton);
$("#collapseSearch").append(nextButton);
//prevButton.text("Prev.").attr("data-value", results.previous);
//nextButton.text("Next.").attr("data-value", results.next);
$("#btn-next").attr("data-value", response.tracks.next);





$("#song-search").val("");
nextButton.text("Next.");
prevButton.text("Prev.");
var newTrack = response.tracks.items;
renderResults(newTrack);


$(document).on("click", ".searchNav", function(){
   if($(this).attr("data-value") === null){
      $(this).attr("disabled", true);
    } else {
      $(this).attr("disabled", false);
      //$("#btn-prev").attr("disabled", false);
      console.log($(this).data("value"));
  $.ajax({
  url: $(this).attr("data-value"),
  headers: {
    'Authorization': 'Bearer ' + access_token
  },
  success: function(result) {
console.log(result);

var newNext = result.tracks.next;
var newPrev = result.tracks.previous;
console.log(newNext);
$("#btn-prev").attr("data-value", newPrev);
$("#btn-next").attr("data-value", newNext);
if(newPrev === null){
  $("#btn-prev").attr("disabled", true);
} else {
  $("#btn-prev").attr("disabled", false);
}
var moreTracks = result.tracks.items;
renderResults(moreTracks);
  }
})
}})
}

})
}
})





function renderResults(newTrack){
  $("#search-results").empty();
  //if($("#btn-prev").attr("data-value") === null){
     // $("#btn-prev").attr("disabled", true);
   // } else {
      //$("#btn-prev").attr("disabled", false);}
$.each(newTrack, function(i){
var newTrackIndex = [i];
var newImage = newTrack[i].album.images[1].url;
var trackDiv = $('<div class="d-flex results mb-3">');
var searchTable = $('<table class="table table-hover">');
var searchTableHead = $('<thead>');
var searchTableBody = $('<tbody>');
var searchTableRow2 = $('<tr>');
var searchTableRow3 = $('<tr>');
var searchTablePlayer = $('<td colspan="3">');
var searchTableMv = $('<td colspan="3">');
var uniqueId = newTrackIndex + "song" + newTrack[i].track_number + "A" + newTrack[i].id;
var uniqueId2 = newTrackIndex + "button" + newTrack[i].track_number + "B" + newTrack[i].id;
var uniqueId3 = newTrackIndex + "MV" + newTrack[i].track_number + "C" + newTrack[i].id;
  $("#search-results").append(trackDiv);
  trackDiv.append(searchTable);
  searchTable.append(searchTableHead);
  searchTableHead.append("<tr><th scope='col'>" + "Title" + "</th><th scope='col'>" + "Artist" + "</th><th scope='col'>" + "Album" + "</th></tr>"); 
var searchImage = $('<img>');
searchImage.attr("src", newImage);
trackDiv.prepend(searchImage);
searchTable.append(searchTableBody);
searchTableRow2.attr("id", uniqueId);
searchTableRow3.attr("id", uniqueId2);


//make music video button and preview audio player
var newMvButton = $('<button class="btn btn-primary music-video">');
var newPvwPlayer = $('<audio controls preload="auto">');
var newPreview = $('<source>');
var newPreviewClip = newTrack[i].preview_url;
var newTitle = newTrack[i].name;
var newAlbum = newTrack[i].album.name;
var newArtists = newTrack[i].artists;
var newArtistArr = [];

$.each(newArtists, function(j){
  var newMultiArtists = newArtists[j].name;
  newArtistArr.push(newMultiArtists);
})

var newArtist = newArtistArr.join(', ');
var videoSearchValue =  newArtists[0].name + newTitle + " official";

searchTableBody.append("<tr><td class='title'>" + newTitle + "</td><td class='artist'>" + newArtist + "</td><td class='album'>" + newAlbum + "</td></tr>");
searchTableBody.append(searchTableRow2);
$("#" + uniqueId).append(searchTablePlayer);
searchTableBody.append(searchTableRow3);
$("#" + uniqueId2).append(searchTableMv);
searchTableMv.append(newMvButton)
searchTablePlayer.append(newPvwPlayer);
newPvwPlayer.append(newPreview);

newPreview.attr("src", newPreviewClip);
newMvButton.text("Music Video").attr({
  id: uniqueId3,
  "data-toggle": "modal",
   "data-target": "#videoModal",
   "data-video": videoSearchValue
}); 




})
}




//keeps two tracks from playing at the same time
document.addEventListener('play', function(e){
  var audios = document.getElementsByTagName('audio');
  for(var i = 0, len = audios.length; i < len; i++){
    if(audios[i] != e.target) {
      audios[i].pause();
    }
  }
}, true);

$(document).on("click", function(){
  $($("li").children("a")).not($(".collapsed")).collapse({
    toggle: false
});
})

$(document).on("click", ".music-video", function(){
  console.log("works");
  var audios = document.getElementsByTagName('audio');
  for(var i = 0, len = audios.length; i < len; i++){
    if(audios[i].paused != true){
    audios[i].pause();}
    }
  })

    $('#login').hide();
    $('#loggedin').show();
  }
});


        } else {
    
            // render initial screen
            $('#login').show();
            $('#loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function() {
            $.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
              
         
            });
          }, false);
        
      }
    })();
  
    $(document).ready(function() {
      $(document).on("click", ".music-video", function(){
       var searchValue = $(this).data("video");
       console.log(searchValue);
       var buttonId = $(this).attr("id");
       console.log(buttonId);
       function start() {
  // 2. Initialize the JavaScript client library.
  gapi.client.init({
    'apiKey': 'AIzaSyB8OV4TyFEjIy3hIFgA8ol7RIHb7KTvt8U',
    URL: 'https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&q=overdoseOfficial&type=video&key=AIzaSyB8OV4TyFEjIy3hIFgA8ol7RIHb7KTvt8U'
  }).then(function(response) {
    // 3. Initialize and make the API request.
    return gapi.client.request({
      'path': "https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&q=" + searchValue + "&type=video&key=AIzaSyB8OV4TyFEjIy3hIFgA8ol7RIHb7KTvt8U",
    })
  }).then(function(response) {
    console.log(response.result);
    console.log(this);
    searchVidId = response.result.items[0].id.videoId;
   console.log(buttonId);
    $("#" + buttonId).attr('data-theVideo', searchVidId);
    autoPlayYouTubeModal(buttonId);
  }, function(reason) {
    console.log('Error: ' + reason.result.error.message);
  });
};
// 1. Load the JavaScript client library.
gapi.load('client', start);

  }) 









function autoPlayYouTubeModal(buttonId){
  
    var theModal = $("#" + buttonId).data( "target" ),
    videoSRC = $("#" + buttonId).attr( "data-thevideo" ),  
    videoSRCauto = "https://www.youtube.com/embed/" + videoSRC + "?html5=1";
    console.log(videoSRC);
    console.log(videoSRCauto);
    $(theModal+' iframe').attr('src', videoSRCauto);
    $(theModal+' button.close').click(function () {
        $(theModal+' iframe').attr('src', videoSRC);
       
  });
}



    })




 



    // After the API loads, call a function to enable the search box.


    
   
  </script>



    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
   
</html>