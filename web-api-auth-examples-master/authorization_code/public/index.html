<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    
    <!--link rel="stylesheet" type="text/css" href="assets/css/style.css"-->
    <link href="https://fonts.googleapis.com/css?family=Abril+Fatface" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    


    <title>Delta</title>

    <style type="text/css">
        #login, #loggedin {
          display: none;
        }
        .text-overflow {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          width: 500px;
        }
      </style>

  </head>

  <div class="container" id="head-container">
        <div class="container">
                <div id="login">
                  <h1>This is an example of the Authorization Code flow</h1>
                  <a href="/login" class="btn btn-primary">Log in with Spotify</a>
                </div>
                <div id="loggedin">
                  <div id="user-profile">
                  </div>
                  <div id="oauth">
                  </div>
                  <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
                </div>
              </div>
    <div class="jumbotron" id="head">
        <h1> SpoTube </h1>
        <h3>Music Refined</h3>
    </div>
</div>

<div class="container" id="dataBody">
  
  <div class="panel panel-default">
      <div class="panel-heading panel-custom">
          Playlists
      </div>
      <table class="table table-hover">
          <tr>
              <th scope="col">Title</th>
              <th scope="col">Artist</th>
              <th scope="col">Album</th>
              <th scope="col"></th>
              
          </tr>
          <tbody id="table-data"></tbody>
      </table>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading panel-custom">  Add Song </div>
    <div class="panel-body">
        <form>
            <div class="form-group">
                <label for="endYear">Search</label>
                <input type="text" class="form-control" id="time-freq">
            </div>
            <div class="btn-group" role="group">
                <button type="button" id="btn-add" class="btn search-button">Submit</button>
            </div>
        </form>
    </div>
</div>
<script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
      <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
      <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
  </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (function() {

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
            q = window.location.hash.substring(1);
        while ( e = r.exec(q)) {
           hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      var params = getHashParams();

      var access_token = params.access_token,
          refresh_token = params.refresh_token,
          error = params.error;

      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
        
$.ajax({
  url: 'https://api.spotify.com/v1/me/playlists',
  headers: {
    'Authorization': 'Bearer ' + access_token
  },
  success: function(response) {
    console.log(response);
   var playResults = response.items;
    console.log(playResults);
    var playlistHead = $('<div class="accordion" id="accordionPlaylists">');
   $("#dataBody").append(playlistHead);

    for(var i = 0; i < playResults.length; i++){
      (function (i){

      var playlistBody = $("<div>");
        playlistBody.attr("id", "playlist" + [i]);
      var pLists = $("<p>");
      var songTracks = $("<div>");
       console.log(i);

        pLists.text(playResults[i].name);
        $("#playlists").append(playlistBody);
        $("#playlist"+[i]).append(pLists);
        $("#playlist"+[i]).append(songTracks);
        
        playlistID = playResults[i].id;
        userId = playResults[i].owner.id;
        trackCount = playResults[i].tracks.total;
 console.log(trackCount)



 //call gives me everything i need in a single call look into not doing the first call and see how that works out
      $.ajax({
        url: 'https://api.spotify.com/v1/users/'+ userId +'/playlists/'+playlistID+ '/',
        headers: {
    'Authorization': 'Bearer ' + access_token
  },
  success: function(result) {
    console.log(result);
    var pName = result.name;
    console.log(pName);
    var pId = result.id;
    var trackName = result.tracks
    console.log(trackName);
    var trackList = result.tracks.items;
    console.log(trackList);

var plCard = $('<div class="card">');
var plCardHead = $('<div class="card-header">');
var plWrap = $('<h5 class="mb-0">');
var plButton = $('<a class="display-4"  data-toggle="collapse"  aria-expanded="false" >');
    
var plTarget = $('<div class="collapse" data-parent="#accordionPlaylists">');
var plCardBody = $('<div class="card-body">');
var songList = $("<ul>");

var plHeading = "heading" + pId;
var plWrapping = "wrapping" + pId;  //h5
var plCollapse = "collapse" + pId;
var plTargeted = "target" + pId;
var plSongList = "list" + pId;

var plCardId = "#"+ pId;
var plHeadingId = "#" + plHeading;
var plWrappingId = "#" + plWrapping;
var plCollapseId = "#" + plCollapse;
var plTargetId = "#" + plTargeted;
var plSongListId = "#" + plSongList;

plCard.attr("id", pId);
plCardHead.attr("id", plHeading);
plWrap.attr("id", plWrapping);
plButton.attr({
  href: plCollapseId,
  "data-target": plCollapseId,
  "aria-controls": plCollapse
});


plTarget.attr({
  id: plCollapse,
  "aria-labelledby": plHeading
});
plCardBody.attr("id", plTargeted);
songList.attr("id", plSongList);
$(plButton).text(pName);
$("#accordionPlaylists").append(plCard);
$(plCardId).append(plCardHead);
$(plHeadingId).append(plWrap);

$(plWrappingId).append(plButton);
$(plCardId).append(plTarget);
$(plCollapseId).append(plCardBody);
$(plTargetId).append(songList);
var noSpace = pName.replace(/\s/g, '');
console.log(noSpace);
//returns back all the tracks per playlist in an array
console.log(trackList);
if(trackList){

$.each(trackList, function(j){

var tId = trackList[j].track.id;
console.log([j]);
console.log(tId)
var plTrackList = $('<li>');
var songToggle = $('<a  data-toggle="collapse"  role="button" aria-expanded="false" >');

var songInfoDiv = $('<div class="collapse">');
var songInfoTable = $('<table class="table table-hover">');
var tableHeadRow = $('<tr>');
var tableHeadArtist = $('<th scope="col">');
var tableHeadAlbum = $("<th scope='col'>");
var innerCollapseDiv = $('<div>');
var trackTableHead =$('<thead>');
var trackTableBody = $('<tbody>');
var tableDataRow = $('<tr>');
var trackAlbum = $('<td>');
var trackArtist = $('<td>');


var plTrack = [j]+noSpace + tId;
var songToggleLink = [j]+noSpace + "link" + tId;
var songToggler = [j]+noSpace + "collapse" + tId;
var songInfoDiver = [j]+noSpace + "div" + tId;
var songInfoTabler = [j]+noSpace + "table" + tId;
var innerDiv = [j]+noSpace + "inner" + tId;
var headRow = [j]+noSpace + "head-row" + tId;
var tableBody = [j]+noSpace + "table-data" + tId;
var tableAlbum = [j]+noSpace + "album" + tId;
var tableArtist = [j]+noSpace + "artist" + tId;
var dataRow = [j]+noSpace + "track" + tId;
var songAlbum = [j]+noSpace + "sngAlbum" + tId;
var songArtist = [j]+noSpace + "sngArtist" + tId;
var tableHead = [j]+noSpace + "head" + tId;

var plTrackListId = "#" + plTrack;

var songToggleId = "#" + songToggler;
var songToggleLinkId = "#" + songToggleLink;
var innerDivId = "#" + innerDiv;
var headRowId = "#" + headRow;
var songInfoTableId = "#" + songInfoTabler;
var tableBodyId = "#" + tableBody;
var tableAlbumId = "#" + tableAlbum;
var tableArtistId = "#" + tableArtist;
var tableDataRowId = "#" + dataRow;
var songAlbumId = "#" + songAlbum;
var songArtistId = "#" + songArtist;
var tableHeadId = "#" + tableHead;

plTrackList.attr("id", plTrack);

songToggle.attr({
  id: songToggleLink,
  href: songToggleId,
  "aria-controls": songToggler
 });

innerCollapseDiv.attr("id", innerDiv);
songInfoDiv.attr("id", songToggler);
songInfoTable.attr("id", songInfoTabler);
if(tableAlbumId){
tableHeadAlbum.text("Album").attr("id", tableAlbumId);
tableHeadArtist.text("Artist").attr("id", tableArtistId);
}
tableHeadRow.attr("id", headRow);
tableDataRow.attr("id", dataRow);
trackTableBody.attr("id", tableBody);
trackArtist.attr("id", songArtist);
trackAlbum.attr("id", songAlbum);
trackTableHead.attr("id", tableHead);




$(plSongListId).append(plTrackList);
$(plTrackListId).append(songToggle);
$(plTrackListId).append(innerCollapseDiv);
$(innerDivId).append(songInfoDiv);
$(songToggleId).append(songInfoTable);

$(songInfoTableId).append(trackTableHead);
$(tableHeadId).append(tableHeadRow);

$(headRowId).append(tableHeadArtist);
$(headRowId).append(tableHeadAlbum);



$(songInfoTableId).append(trackTableBody);
$(tableBodyId).append(tableDataRow);
$(tableDataRowId).append(trackArtist);
$(tableDataRowId).append(trackAlbum);

var title = trackList[j].track.name;
var album = trackList[j].track.album.name;
 //figure out what to do if there is more than one artist in the artist array
var artist = trackList[j].track.artists[0].name;

$(songToggleLinkId).text(title);
$(songAlbumId).text(album);
$(songArtistId).text(artist);
 


 

 
})
}
  }  
  
})
}(i))
}
      

    $('#login').hide();
    $('#loggedin').show();
  }
});
       

          $.ajax({
              url: 'https://api.spotify.com/v1/users/'+ userId +'/playlists/'+ playlistID +'?fields=tracks.items(track(name,href,album(name,href)))',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                //userProfilePlaceholder.innerHTML = userProfileTemplate(response);
console.log(response);
               $('#login').hide();
                $('#loggedin').show();
              }
          });
        } else {
            // render initial screen
            $('#login').show();
            $('#loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function() {
          $.ajax({
            url: '/refresh_token',
            data: {
              'refresh_token': refresh_token
            }
          }).done(function(data) {
            access_token = data.access_token;
            //oauthPlaceholder.innerHTML = oauthTemplate({
              //access_token: access_token,
             // refresh_token: refresh_token
           // });
          });
        }, false);
      }
    })();
  </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
   
</html>